<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>XO Game + Video Call</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: sans-serif;
      background: linear-gradient(to right, #00c6ff, #0072ff);
      color: white;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    input, button {
      padding: 10px;
      margin: 5px;
      font-size: 16px;
      border-radius: 5px;
      border: none;
    }
    table {
      margin: 20px auto;
      border-collapse: collapse;
    }
    td {
      width: 80px;
      height: 80px;
      font-size: 36px;
      background: white;
      color: black;
      border: 2px solid #333;
      cursor: pointer;
    }
    #chatMessages {
      background: rgba(255,255,255,0.9);
      color: black;
      max-height: 150px;
      overflow-y: auto;
      padding: 10px;
      border-radius: 10px;
      margin: 10px auto;
      width: 80%;
      text-align: left;
    }
    video {
      width: 45%;
      border-radius: 10px;
      margin: 5px;
    }
    #winnerOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      color: white;
      font-size: 32px;
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 999;
    }
  </style>
</head>
<body>
  <h1>XO Game üéÆ + Video Call üìπ</h1>

  <div>
    Name: <input id="playerName" placeholder="Your name" />
    Room ID: <input id="roomId" value="room123" />
    <button onclick="joinRoom()">Join Room</button>
  </div>

  <h3 id="status">Not connected</h3>
  <h4 id="playersDisplay"></h4>
  <table id="board"></table>

  <div id="winnerOverlay">
    <div id="winnerText">üéâ Winner! üéâ</div>
  </div>

  <div>
    <button onclick="startVideoCall()">üìπ Start Video Call</button>
    <button onclick="endCall()">‚ùå End Call</button>
  </div>
  <div>
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>

  <h3>üí¨ Room Chat</h3>
  <div id="chatMessages"></div>
  <input type="text" id="chatInput" placeholder="Message..." style="width:60%" />
  <button onclick="sendMessage()">Send</button>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyClhTG2xUVZSYi7LnXtKVzUh4_G2PK-VYk",
      databaseURL: "https://airvat-4ca28-default-rtdb.firebaseio.com",
      projectId: "airvat-4ca28",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let playerName = "", currentRoom = "", myMark = "", localStream, peerConnection;
    const boardEl = document.getElementById("board");
    const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    function joinRoom() {
      playerName = document.getElementById("playerName").value.trim();
      currentRoom = document.getElementById("roomId").value.trim();
      if (!playerName || !currentRoom) return alert("Enter name and room");

      const playersRef = db.ref(`games/${currentRoom}/players`);
      playersRef.once("value").then(snap => {
        const players = snap.val() || {};
        if (!players.X) {
          myMark = "X";
          playersRef.child("X").set(playerName);
        } else if (!players.O) {
          myMark = "O";
          playersRef.child("O").set(playerName);
        } else {
          return alert("Room full!");
        }

        setupBoard();
        listenToPlayers();
        listenToBoard();
        listenToChat();
        listenForOffer(); // auto connect
      });
    }

    function setupBoard() {
      boardEl.innerHTML = "";
      for (let r = 0; r < 3; r++) {
        const row = boardEl.insertRow();
        for (let c = 0; c < 3; c++) {
          const cell = row.insertCell();
          cell.dataset.row = r;
          cell.dataset.col = c;
          cell.onclick = cellClicked;
        }
      }
      document.getElementById("status").innerText = `You're '${myMark}'`;
    }

    function cellClicked(e) {
      const row = e.target.dataset.row;
      const col = e.target.dataset.col;
      if (e.target.innerText) return;

      const turnRef = db.ref(`games/${currentRoom}/turn`);
      turnRef.once("value").then(snap => {
        const turn = snap.val() || "X";
        if (turn !== myMark) return;

        db.ref(`games/${currentRoom}/board/${row}_${col}`).set(myMark);
        turnRef.set(myMark === "X" ? "O" : "X");
      });
    }

    function listenToPlayers() {
      db.ref(`games/${currentRoom}/players`).on("value", snap => {
        const players = snap.val() || {};
        const other = myMark === "X" ? "O" : "X";
        document.getElementById("playersDisplay").innerText =
          `${players[myMark] || "You"} (You) vs ${players[other] || "..."}`;
      });
    }

    function listenToBoard() {
      db.ref(`games/${currentRoom}/board`).on("value", snap => {
        const board = snap.val() || {};
        for (let r = 0; r < 3; r++) {
          for (let c = 0; c < 3; c++) {
            const cell = boardEl.rows[r].cells[c];
            const val = board[`${r}_${c}`] || "";
            cell.innerText = val;
          }
        }
        checkWin(board);
      });
    }

    function checkWin(board) {
      const get = (r, c) => board[`${r}_${c}`] || "";
      const lines = [
        [[0,0],[0,1],[0,2]], [[1,0],[1,1],[1,2]], [[2,0],[2,1],[2,2]],
        [[0,0],[1,0],[2,0]], [[0,1],[1,1],[2,1]], [[0,2],[1,2],[2,2]],
        [[0,0],[1,1],[2,2]], [[0,2],[1,1],[2,0]]
      ];
      for (let line of lines) {
        const [a,b,c] = line;
        const v = get(...a);
        if (v && v === get(...b) && v === get(...c)) {
          document.getElementById("winnerText").innerText = `${v} wins! üéâ`;
          document.getElementById("winnerOverlay").style.display = "flex";
          setTimeout(() => {
            document.getElementById("winnerOverlay").style.display = "none";
            db.ref(`games/${currentRoom}/board`).remove();
            db.ref(`games/${currentRoom}/turn`).remove();
          }, 3000);
        }
      }
    }

    function sendMessage() {
      const msg = document.getElementById("chatInput").value.trim();
      if (!msg) return;
      const time = Date.now();
      db.ref(`games/${currentRoom}/chat/${time}`).set({ name: playerName, text: msg });
      document.getElementById("chatInput").value = "";
    }

    function listenToChat() {
      const chatBox = document.getElementById("chatMessages");
      db.ref(`games/${currentRoom}/chat`).on("child_added", snap => {
        const d = snap.val();
        const div = document.createElement("div");
        div.innerHTML = `<b>${d.name}:</b> ${d.text}`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    }

    async function startVideoCall() {
      const roomRef = db.ref(`videoRooms/${currentRoom}`);
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      document.getElementById("localVideo").srcObject = localStream;

      peerConnection = new RTCPeerConnection(config);
      localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));
      peerConnection.ontrack = e => {
        document.getElementById("remoteVideo").srcObject = e.streams[0];
      };
      peerConnection.onicecandidate = e => {
        if (e.candidate) roomRef.child('candidates').push(JSON.stringify(e.candidate));
      };

      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      roomRef.child('offer').set(JSON.stringify(offer));

      roomRef.child('answer').on('value', async snap => {
        if (snap.exists() && !peerConnection.currentRemoteDescription) {
          await peerConnection.setRemoteDescription(JSON.parse(snap.val()));
        }
      });

      roomRef.child('candidates').on('child_added', async snap => {
        const data = JSON.parse(snap.val());
        await peerConnection.addIceCandidate(new RTCIceCandidate(data));
      });
    }

    async function listenForOffer() {
      const roomRef = db.ref(`videoRooms/${currentRoom}`);
      roomRef.child('offer').on('value', async snap => {
        if (!snap.exists()) return;
        const offer = JSON.parse(snap.val());

        if (!peerConnection) {
          peerConnection = new RTCPeerConnection(config);

          peerConnection.ontrack = e => {
            document.getElementById("remoteVideo").srcObject = e.streams[0];
          };
          peerConnection.onicecandidate = e => {
            if (e.candidate) roomRef.child('candidates').push(JSON.stringify(e.candidate));
          };

          localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
          document.getElementById("localVideo").srcObject = localStream;
          localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
        }

        await peerConnection.setRemoteDescription(offer);
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        roomRef.child('answer').set(JSON.stringify(answer));
      });

      roomRef.child('candidates').on('child_added', async snap => {
        const data = JSON.parse(snap.val());
        if (peerConnection) {
          try {
            await peerConnection.addIceCandidate(new RTCIceCandidate(data));
          } catch (e) { console.log("ICE error", e); }
        }
      });
    }

    async function endCall() {
      const roomRef = db.ref(`videoRooms/${currentRoom}`);
      if (peerConnection) peerConnection.close();
      if (localStream) localStream.getTracks().forEach(t => t.stop());
      document.getElementById("localVideo").srcObject = null;
      document.getElementById("remoteVideo").srcObject = null;
      roomRef.remove();
    }
  </script>
</body>
</html>

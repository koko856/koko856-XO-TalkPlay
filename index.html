<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>XO Voice Game by @Scarykkkk</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Kanit', sans-serif;
      text-align: center;
      background: linear-gradient(to right, #f2fcfe, #1c92d2);
      margin: 0; padding: 0;
    }
    h2 {
      font-size: 28px;
      color: white;
      margin-top: 20px;
    }
    input, button {
      font-size: 16px;
      padding: 8px 12px;
      margin: 5px;
      border-radius: 5px;
    }
    table {
      margin: auto;
      border-collapse: collapse;
      margin-top: 20px;
    }
    td {
      width: 80px; height: 80px;
      font-size: 36px;
      border: 2px solid #333;
      background: white;
      cursor: pointer;
    }
    td.marked {
      background: #d0f0c0;
    }
    #status {
      font-size: 20px;
      margin-top: 10px;
      color: white;
    }
    #winnerOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: white;
      font-size: 28px;
      z-index: 9999;
    }
    #producer {
      margin-top: 10px;
      font-size: 20px;
      color: #ffcc00;
    }
  </style>
</head>
<body>
  <h2>XO Voice Game</h2>

  <div>
    Name: <input type="text" id="playerName" placeholder="Your name" />
    Room ID: <input type="text" id="roomId" value="room123" />
    <button onclick="joinRoom()">Join Room</button>
  </div>

  <div id="status">Waiting for players...</div>
  <h3 id="playersDisplay"></h3>
  <table id="board"></table>

  <div style="margin-top: 20px;">
    <button onclick="startCall()">üéô Start Voice</button>
    <button onclick="endCall()">‚ùå End</button>
    <audio id="remoteAudio" autoplay></audio>
  </div>

  <div id="winnerOverlay">
    <div id="winnerName">üéâ Winner! üéâ</div>
    <div id="producer">Produced by @Scarykkkk</div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyClhTG2xUVZSYi7LnXtKVzUh4_G2PK-VYk",
      databaseURL: "https://airvat-4ca28-default-rtdb.firebaseio.com",
      projectId: "airvat-4ca28"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const board = document.getElementById("board");
    const statusEl = document.getElementById("status");
    const winnerOverlay = document.getElementById("winnerOverlay");
    const winnerName = document.getElementById("winnerName");
    const playersDisplay = document.getElementById("playersDisplay");

    let playerName = "", currentRoom = "", myMark = "";
    let peerConnection, localStream;
    const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    function joinRoom() {
      playerName = document.getElementById("playerName").value.trim();
      currentRoom = document.getElementById("roomId").value.trim();
      if (!playerName || !currentRoom) return alert("Fill in both fields");

      const playersRef = db.ref(`games/${currentRoom}/players`);
      playersRef.once("value").then(snapshot => {
        const players = snapshot.val() || {};
        if (!players.X) {
          playersRef.child("X").set(playerName);
          myMark = "X";
        } else if (!players.O) {
          playersRef.child("O").set(playerName);
          myMark = "O";
        } else {
          alert("Room full!");
          return;
        }
        setupBoard();
        listenToBoard();
        listenToPlayers();
        listenForCall();
      });
    }

    function setupBoard() {
      board.innerHTML = "";
      for (let r = 0; r < 3; r++) {
        const row = board.insertRow();
        for (let c = 0; c < 3; c++) {
          const cell = row.insertCell();
          cell.dataset.row = r;
          cell.dataset.col = c;
          cell.innerText = "";
          cell.className = "";
          cell.onclick = cellClicked;
        }
      }
      statusEl.innerText = `You are '${myMark}'`;
    }

    function cellClicked(e) {
      const cell = e.target;
      const row = cell.dataset.row;
      const col = cell.dataset.col;
      if (cell.innerText !== "") return;

      const turnRef = db.ref(`games/${currentRoom}/turn`);
      turnRef.once("value").then(snap => {
        const turn = snap.val() || "X";
        if (turn !== myMark) return;
        db.ref(`games/${currentRoom}/board/${row}_${col}`).set(myMark);
        turnRef.set(myMark === "X" ? "O" : "X");
      });
    }

    function listenToBoard() {
      db.ref(`games/${currentRoom}/board`).on("value", snap => {
        const b = snap.val() || {};
        for (let r = 0; r < 3; r++) {
          for (let c = 0; c < 3; c++) {
            const val = b[`${r}_${c}`] || "";
            const cell = board.rows[r].cells[c];
            if (cell.innerText !== val) {
              cell.innerText = val;
              if (val) cell.classList.add("marked");
            }
          }
        }
        checkGameEnd(b);
      });
    }

    function listenToPlayers() {
      db.ref(`games/${currentRoom}/players`).on("value", snap => {
        const players = snap.val() || {};
        const other = myMark === "X" ? "O" : "X";
        playersDisplay.innerText = `${players[myMark] || "You"} (You) vs ${players[other] || "..."}`;
      });
    }

    function checkGameEnd(b) {
      const get = (r,c) => b[`${r}_${c}`] || "";
      const lines = [
        [[0,0],[0,1],[0,2]], [[1,0],[1,1],[1,2]], [[2,0],[2,1],[2,2]],
        [[0,0],[1,0],[2,0]], [[0,1],[1,1],[2,1]], [[0,2],[1,2],[2,2]],
        [[0,0],[1,1],[2,2]], [[0,2],[1,1],[2,0]]
      ];
      for (let line of lines) {
        const [a,b,c] = line;
        const v = get(...a);
        if (v && v === get(...b) && v === get(...c)) {
          showWinner(v);
          return;
        }
      }
      if (Object.keys(b).length === 9) showWinner("Draw");
    }

    function showWinner(winner) {
      winnerName.innerText = winner === "Draw" ? "ü§ù Draw!" : `${winner} Wins üéâ`;
      winnerOverlay.style.display = "flex";
      setTimeout(() => {
        winnerOverlay.style.display = "none";
        db.ref(`games/${currentRoom}/board`).remove();
        db.ref(`games/${currentRoom}/turn`).remove();
        window.location.href = "https://t.me/Scarykkkk";
      }, 3000);
    }

    function voiceRoomRef() {
      return db.ref(`voiceRooms/${currentRoom}`);
    }

    async function startCall() {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      peerConnection = new RTCPeerConnection(configuration);
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

      peerConnection.ontrack = e => {
        document.getElementById("remoteAudio").srcObject = e.streams[0];
      };
      peerConnection.onicecandidate = e => {
        if (e.candidate) voiceRoomRef().child("candidates").push(JSON.stringify(e.candidate));
      };

      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      voiceRoomRef().child("offer").set(JSON.stringify(offer));

      voiceRoomRef().child("answer").on("value", async snap => {
        if (snap.exists() && !peerConnection.currentRemoteDescription) {
          await peerConnection.setRemoteDescription(JSON.parse(snap.val()));
        }
      });

      voiceRoomRef().child("candidates").on("child_added", async snap => {
        const candidate = new RTCIceCandidate(JSON.parse(snap.val()));
        await peerConnection.addIceCandidate(candidate);
      });
    }

    async function listenForCall() {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      peerConnection = new RTCPeerConnection(configuration);
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

      peerConnection.ontrack = e => {
        document.getElementById("remoteAudio").srcObject = e.streams[0];
      };
      peerConnection.onicecandidate = e => {
        if (e.candidate) voiceRoomRef().child("candidates").push(JSON.stringify(e.candidate));
      };

      voiceRoomRef().child("offer").on("value", async snap => {
        if (snap.exists() && !peerConnection.currentRemoteDescription) {
          const offer = JSON.parse(snap.val());
          await peerConnection.setRemoteDescription(offer);
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);
          voiceRoomRef().child("answer").set(JSON.stringify(answer));
        }
      });

      voiceRoomRef().child("candidates").on("child_added", async snap => {
        const candidate = new RTCIceCandidate(JSON.parse(snap.val()));
        await peerConnection.addIceCandidate(candidate);
      });
    }

    function endCall() {
      if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
      }
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
      }
      voiceRoomRef().remove();
    }
  </script>
</body>
</html>
